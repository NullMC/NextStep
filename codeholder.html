<?php
header('Content-Type: application/json; charset=utf-8');

// Funzione per normalizzare le stringhe
function normalizeString($str) {
    if (!$str) return '';
    
    $str = strtolower($str);
    $str = str_replace(
        ['à', 'á', 'ä', 'â', 'è', 'é', 'ë', 'ê', 'ì', 'í', 'ï', 'î', 'ò', 'ó', 'ö', 'ô', 'ù', 'ú', 'ü', 'û', 'ç', 'ñ'],
        ['a', 'a', 'a', 'a', 'e', 'e', 'e', 'e', 'i', 'i', 'i', 'i', 'o', 'o', 'o', 'o', 'u', 'u', 'u', 'u', 'c', 'n'],
        $str
    );
    $str = preg_replace('/\s+/', ' ', $str);
    return trim($str);
}

// Ottieni i parametri POST
$regione = isset($_POST['regione']) ? $_POST['regione'] : '';
$provincia = isset($_POST['provincia']) ? $_POST['provincia'] : '';
$keywordsStr = isset($_POST['keywords']) ? $_POST['keywords'] : '';
$keywords = array_map('trim', explode(',', $keywordsStr));

// Path del file CSV - modifica questo percorso secondo la tua struttura
$csvFile = 'data/scuole.csv';

// Verifica che il file esista
if (!file_exists($csvFile)) {
    echo json_encode([
        'success' => false,
        'error' => 'File CSV non trovato',
        'schools' => []
    ]);
    exit;
}

// Leggi il file CSV
$schools = [];
$handle = fopen($csvFile, 'r');

if ($handle === false) {
    echo json_encode([
        'success' => false,
        'error' => 'Impossibile aprire il file CSV',
        'schools' => []
    ]);
    exit;
}

// Leggi l'intestazione
$headers = fgetcsv($handle, 0, ',');
if ($headers === false) {
    echo json_encode([
        'success' => false,
        'error' => 'Intestazione CSV non valida',
        'schools' => []
    ]);
    fclose($handle);
    exit;
}

// Normalizza gli headers per facilitare il mapping
$normalizedHeaders = array_map('normalizeString', $headers);

// Trova gli indici delle colonne
$indices = [
    'regione' => -1,
    'provincia' => -1,
    'codice' => -1,
    'denominazione' => -1,
    'indirizzo' => -1,
    'tipologia' => -1,
    'email' => -1,
    'pec' => -1,
    'sito' => -1
];

foreach ($normalizedHeaders as $index => $header) {
    if (strpos($header, 'regione') !== false) {
        $indices['regione'] = $index;
    } elseif (strpos($header, 'provincia') !== false) {
        $indices['provincia'] = $index;
    } elseif (strpos($header, 'codice') !== false && strpos($header, 'istituto') !== false) {
        $indices['codice'] = $index;
    } elseif (strpos($header, 'denominazione') !== false || strpos($header, 'nome') !== false) {
        $indices['denominazione'] = $index;
    } elseif (strpos($header, 'indirizzo') !== false) {
        $indices['indirizzo'] = $index;
    } elseif (strpos($header, 'tipologia') !== false || strpos($header, 'grado') !== false) {
        $indices['tipologia'] = $index;
    } elseif (strpos($header, 'email') !== false && strpos($header, 'pec') === false) {
        $indices['email'] = $index;
    } elseif (strpos($header, 'pec') !== false) {
        $indices['pec'] = $index;
    } elseif (strpos($header, 'sito') !== false || strpos($header, 'web') !== false) {
        $indices['sito'] = $index;
    }
}

// Leggi tutte le righe
$allSchools = [];
while (($data = fgetcsv($handle, 0, ',')) !== false) {
    if (count($data) < count($headers)) {
        continue;
    }
    
    $school = [
        'regione' => $indices['regione'] >= 0 ? trim($data[$indices['regione']]) : '',
        'provincia' => $indices['provincia'] >= 0 ? trim($data[$indices['provincia']]) : '',
        'codice' => $indices['codice'] >= 0 ? trim($data[$indices['codice']]) : '',
        'denominazione' => $indices['denominazione'] >= 0 ? trim($data[$indices['denominazione']]) : '',
        'indirizzo' => $indices['indirizzo'] >= 0 ? trim($data[$indices['indirizzo']]) : '',
        'tipologia' => $indices['tipologia'] >= 0 ? trim($data[$indices['tipologia']]) : '',
        'email' => $indices['email'] >= 0 ? trim($data[$indices['email']]) : 'Non Disponibile',
        'pec' => $indices['pec'] >= 0 ? trim($data[$indices['pec']]) : 'Non Disponibile',
        'sito' => $indices['sito'] >= 0 ? trim($data[$indices['sito']]) : 'Non Disponibile'
    ];
    
    // Aggiungi solo se ha almeno denominazione e regione
    if (!empty($school['denominazione']) && !empty($school['regione'])) {
        $allSchools[] = $school;
    }
}

fclose($handle);

// Filtra le scuole in base ai criteri
$filteredSchools = [];

foreach ($allSchools as $school) {
    // Filtra per regione
    if (normalizeString($school['regione']) !== normalizeString($regione)) {
        continue;
    }
    
    // Filtra per provincia (se specificata)
    if (!empty($provincia)) {
        $schoolProvincia = normalizeString($school['provincia']);
        $searchProvincia = normalizeString($provincia);
        
        if (strpos($schoolProvincia, $searchProvincia) === false && 
            strpos($searchProvincia, $schoolProvincia) === false) {
            continue;
        }
    }
    
    // Filtra per tipologia (se specificata)
    if (!empty($keywords[0])) {
        $matchFound = false;
        $schoolTipologia = normalizeString($school['tipologia']);
        
        foreach ($keywords as $keyword) {
            $normalizedKeyword = normalizeString($keyword);
            if (strpos($schoolTipologia, $normalizedKeyword) !== false) {
                $matchFound = true;
                break;
            }
        }
        
        if (!$matchFound) {
            continue;
        }
    }
    
    $filteredSchools[] = $school;
}

// Limita a 5 risultati
$filteredSchools = array_slice($filteredSchools, 0, 5);

// Restituisci i risultati
echo json_encode([
    'success' => true,
    'count' => count($filteredSchools),
    'schools' => $filteredSchools,
    'debug' => [
        'regione' => $regione,
        'provincia' => $provincia,
        'keywords' => $keywords,
        'total_schools' => count($allSchools)
    ]
], JSON_UNESCAPED_UNICODE);
?>